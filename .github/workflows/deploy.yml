name: Deploy to Railway

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Debug RAILWAY_TOKEN to ensure it's available
      - name: Debug Secrets
        run: |
          if [[ -z "${{ secrets.RAILWAY_TOKEN }}" ]]; then
            echo "‚ùå RAILWAY_TOKEN is missing!"
            exit 1
          fi
          echo "‚úÖ RAILWAY_TOKEN is set."

      # Install Railway CLI
      - name: Install Railway CLI
        run: npm install -g @railway/cli

      # Deploy using Railway CLI
      - name: Deploy via Railway CLI
        run: |
          railway up --service "705a3574-eaee-44d8-9dac-187f7524a6ad" --project "6794a5bd-f6b0-46b2-a199-506694340d97"
        env:
          RAILWAY_TOKEN: b1c8cca6-d574-49e6-adc5-891f28aaddbd

      # Debug API Response (Fallback in case CLI fails)
      - name: Debug API Response
        if: failure()
        run: |
          RESPONSE=$(curl -s -X POST "https://api.railway.app/graphql/v2" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer b1c8cca6-d574-49e6-adc5-891f28aaddbd" \
            --data-raw '{
              "query": "mutation { deployProject(id: \"6794a5bd-f6b0-46b2-a199-506694340d97\", service: \"705a3574-eaee-44d8-9dac-187f7524a6ad\") { id } }"
            }')

          echo "üîç Full Railway Response:"
          echo "$RESPONSE" | jq .

          if echo "$RESPONSE" | grep -q '"errors"'; then
            echo "‚ùå Deployment failed!"
            exit 1
          else
            echo "‚úÖ Deployment triggered successfully!"
          fi

      # Debug Git Logs on Failure
      - name: Debug Git Logs on Failure
        if: failure()
        run: |
          echo "üîç Debugging Git logs..."
          git status
          git log --oneline -n 5
          git branch -a
