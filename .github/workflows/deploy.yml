name: Deploy to Railway

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  
      actions: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  

      - name: Debug GitHub Secrets
        run: |
          if [[ -z "${{ secrets.RAILWAY_TOKEN }}" ]]; then
            echo "‚ùå RAILWAY_TOKEN is missing! Add it in GitHub Secrets."
            exit 1
          fi
          echo "‚úÖ RAILWAY_TOKEN is set."

      - name: Deploy Project via Railway API
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          PROJECT_ID: "f048f3ca-1331-4931-bc33-063e0894822c"
        run: |
          echo "üöÄ Deploying project to Railway..."
          RESPONSE=$(curl -s -X POST "https://api.railway.app/graphql/v2" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            --data-raw "{\"query\":\"mutation { deployProject(id: \\\"$PROJECT_ID\\\") { id } }\"}")
          
          echo "üîç Railway Response: $RESPONSE"
          
          if echo "$RESPONSE" | grep -q '"errors"'; then
            echo "‚ùå Deployment failed!"
            exit 1
          else
            echo "‚úÖ Deployment triggered successfully!"
          fi

      - name: Debug Git Logs on Failure
        if: failure()
        run: |
          echo "üîç Debugging Git logs..."
          git status
          git log --oneline -n 5
          git branch -a
