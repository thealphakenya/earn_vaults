name: "ğŸš€ Auto Deploy to Railway"

on: push: branches: - main

jobs: deploy: runs-on: ubuntu-latest permissions: contents: write actions: write

steps:
  # Step 1: Checkout Repository
  - name: "ğŸ“¥ Checkout Repository"
    uses: actions/checkout@v4
    with:
      fetch-depth: 1  # Fetch only the latest commit for efficiency

  # Step 2: Debug Secrets (Ensure Required Secrets Exist)
  - name: "ğŸ”‘ Check Secrets"
    run: |
      if [[ -z "${{ secrets.RAILWAY_TOKEN }}" ]]; then
        echo "âŒ RAILWAY_TOKEN is missing! Add it in GitHub Secrets."
        exit 1
      fi
      echo "âœ… RAILWAY_TOKEN is set."

  # Step 3: Deploy to Railway using Railway GitHub Action
  - name: "ğŸš€ Deploy to Railway"
    uses: jzeuzs/action-railway@v1.1.4
    with:
      railway_token: ${{ secrets.RAILWAY_TOKEN }}
      args: "--service splendid-commitment"  # Service name specified

  # Step 4: Deploy via Railway API (with Retry)
  - name: "ğŸš€ Trigger Deployment via API"
    run: |
      ATTEMPTS=3
      for ((i=1; i<=ATTEMPTS; i++)); do
        echo "ğŸ”„ Attempt $i of $ATTEMPTS..."
        RESPONSE=$(curl -s -o response.json -w "%{http_code}" -X POST "https://api.railway.app/graphql/v2" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
          --data-raw '{"query":"mutation { deployProject(id: \"6794a5bd-f6b0-46b2-a199-506694340d97\", service: \"splendid-commitment\") { id } }"}')

        if [[ "$RESPONSE" == "200" ]]; then
          echo "âœ… Deployment triggered successfully!"
          exit 0
        else
          echo "âŒ Deployment failed (HTTP $RESPONSE). Retrying..."
          sleep 5
        fi
      done
      echo "ğŸš¨ Deployment failed after $ATTEMPTS attempts."
      exit 1

  # Step 5: Debug Deployment (if Failure Occurs)
  - name: "ğŸ•µï¸ Fetch Deployment Logs (if Failed)"
    if: failure()
    run: |
      echo "ğŸš¨ Deployment failed. Fetching logs..."
      curl -X POST "https://api.railway.app/graphql/v2" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
        --data-raw '{"query":"{ project(id: \"6794a5bd-f6b0-46b2-a199-506694340d97\") { id logs { tail } } }"}'

