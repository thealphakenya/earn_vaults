name: 🚀 Auto Deploy to Railway

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      # Step 1: Checkout Repository
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Fetch only the latest commit for efficiency

      # Step 2: Debug Secrets (Ensure Required Secrets Exist)
      - name: 🔑 Check Secrets
        run: |
          if [[ -z "${{ secrets.RAILWAY_TOKEN }}" ]]; then
            echo "❌ RAILWAY_TOKEN is missing! Add it in GitHub Secrets."
            exit 1
          fi
          echo "✅ RAILWAY_TOKEN is set."

      # Step 3: Install Railway CLI (with Error Handling)
      - name: 🛠 Install Railway CLI
        run: |
          echo "Installing Railway CLI..."
          curl -fsSL https://railway.app/install.sh | sh || {
            echo "❌ Failed to install Railway CLI. Exiting..."
            exit 1
          }
          echo "$HOME/.railway/bin" >> $GITHUB_PATH
          railway --version || echo "⚠️ Railway CLI installation issue"

      # Step 4: Authenticate with Railway (Fixed)
      - name: 🔑 Authenticate Railway CLI
        run: |
          echo "${{ secrets.RAILWAY_TOKEN }}" | railway auth login
          echo "✅ Authenticated with Railway"

      # Step 5: Deploy to Railway (with Auto-Retry)
      - name: 🚀 Deploy via Railway API (with Retry)
        run: |
          ATTEMPTS=3
          for ((i=1; i<=ATTEMPTS; i++)); do
            echo "🔄 Attempt $i of $ATTEMPTS..."
            RESPONSE=$(curl -s -o response.json -w "%{http_code}" -X POST "https://api.railway.app/graphql/v2" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
              --data-raw '{"query":"mutation { deployProject(id: \"f048f3ca-1331-4931-bc33-063e0894822c\") { id } }"}')

            if [[ "$RESPONSE" == "200" ]]; then
              echo "✅ Deployment triggered successfully!"
              exit 0
            else
              echo "❌ Deployment failed (HTTP $RESPONSE). Retrying..."
              sleep 5
            fi
          done
          echo "🚨 Deployment failed after $ATTEMPTS attempts."
          exit 1

      # Step 6: Debug Deployment (if Failure Occurs)
      - name: 🕵️ Fetch Deployment Logs (if Failed)
        if: failure()
        run: |
          echo "🚨 Deployment failed. Fetching logs..."
          curl -X POST "https://api.railway.app/graphql/v2" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            --data-raw '{"query":"{ project(id: \"f048f3ca-1331-4931-bc33-063e0894822c\") { id logs { tail } } }"}'
